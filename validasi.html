<!-- ‚úÖ Versi Lengkap Validasi Jam Kerja -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Validasi Jam Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
    }
    .form-box {
      background-color: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 420px;
      margin: 24px auto;
      box-sizing: border-box;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #0077b6;
      background-color: #d0ecff;
      color: #0077b6;
      font-weight: bold;
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .value {
      font-size: 14px;
      font-weight: bold;
      background-color: #eef6fb;
      padding: 6px;
      border-radius: 6px;
      color: #0077b6;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 16px;
      border-radius: 8px;
      border: none;
      background-color: #a8f0c6;
      color: #006644;
      font-weight: bold;
      cursor: pointer;
    }
    #lokasi-status, #debug-info {
      font-weight: bold;
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
      color: #0077b6;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div class="form-box" id="form-box">
  <h2 style="text-align:center; color:#0077b6;">‚úÖ Validasi Jam Kerja</h2>

  <input type="text" id="nama" placeholder="Nama Santri" readonly />
  <input type="text" id="wa" placeholder="Nomor WA" readonly />

  <div class="grid">
    <div><div class="label">Kegiatan</div><div class="value" id="kegiatan">‚Äî</div></div>
    <div><div class="label">Hari</div><div class="value" id="hari">‚Äî</div></div>
    <div><div class="label">Instansi</div><div class="value" id="instansi">‚Äî</div></div>
    <div><div class="label">Jabatan</div><div class="value" id="jabatan">‚Äî</div></div>
    <div><div class="label">Mulai</div><div class="value" id="mulai">‚Äî</div></div>
    <div><div class="label">Selesai</div><div class="value" id="selesai">‚Äî</div></div>
    <div><div class="label">Durasi</div><div class="value" id="durasi">‚Äî</div></div>
    <div><div class="label">Status</div><div class="value" id="status">‚Äî</div></div>
    <div><div class="label">Durasi Status</div><div class="value" id="drs-status">‚Äî</div></div>
  </div>

  <button id="btn-lokasi">üîê Validasi Lokasi & Absen</button>
  <div id="lokasi-status">‚Äî</div>
  <div id="debug-info">‚Äî</div>
</div>

<script type="module">
  const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_jamker?select=*&wa=ilike.62895403152519&hari=ilike.SELASA&and=(mulai.gte.16:52:03,mulai.lte.17:22:03)&limit=1`;

  fetch(url, {
    headers: {
      apikey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc',
      Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc',
      Accept: 'application/json'
    }
  })
  .then(res => {
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  })
  .then(data => {
    console.log("‚úÖ Data ditemukan:", data);
  })
  .catch(err => {
    console.error("‚ùå Error fetch Supabase:", err.message);
  });

  const $ = id => document.getElementById(id);
  const pesantrenLat = -7.036533;
  const pesantrenLng = 112.743574;
  const radiusAman = 500;
  let dataSantri = null;

  function hitungJarak(lat1, lng1, lat2, lng2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function formatDurasi(ms) {
    const totalSec = Math.abs(Math.floor(ms / 1000));
    const jam = Math.floor(totalSec / 3600);
    const menit = Math.floor((totalSec % 3600) / 60);
    const detik = totalSec % 60;
    return `${jam.toString().padStart(2,'0')} Jam ${menit.toString().padStart(2,'0')} Menit ${detik.toString().padStart(2,'0')} Detik`;
  }

  async function ambilDataSantri(wa) {
    const hariMap = { "MINGGU": "AHAD", "JUMAT": "JUM'AT" };
    const hariSekarang = new Intl.DateTimeFormat("id-ID", { weekday: "long" }).format(new Date()).toUpperCase();
    const hariValid = (hariMap[hariSekarang] || hariSekarang).toUpperCase();

    const sekarang = new Date();
    const batasAwal = new Date(sekarang.getTime() - 30 * 60 * 1000);
    const jamAwal = batasAwal.toTimeString().slice(0, 8);
    const jamSekarang = sekarang.toTimeString().slice(0, 8);

    const { data, error } = await supabase
      .from("tb_jamker")
      .select("*")
      .ilike("wa", wa)
      .ilike("hari", hariValid)
      .gte("mulai", jamAwal)
      .lte("mulai", jamSekarang)
      .limit(1)
      .single();

    if (error || !data) return null;

    const mulai = new Date(`${sekarang.toDateString()} ${data.mulai}`);
    const selisihMs = mulai - sekarang;

    let status = "‚Äî";
    if (Math.abs(selisihMs) <= 5 * 60 * 1000) status = "Pas";
    else if (selisihMs < 0) status = "Telat";
    else status = "Maju";

    const drsStatus = formatDurasi(selisihMs);
    return { ...data, status, drsStatus };
  }

  window.addEventListener("DOMContentLoaded", async () => {
    $("form-box").scrollIntoView({ behavior: "smooth" });

    let wa = new URLSearchParams(window.location.search).get("wa") || "";
    wa = wa.replace(/^\+62/, "628").replace(/[^0-9]/g, "");

    $("wa").value = wa;
    $("debug-info").textContent = `‚úÖ WA berhasil dimuat dari URL: ${wa}`;

    dataSantri = await ambilDataSantri(wa);

if (!dataSantri) {
  $("nama").value = "‚ùå Tidak ditemukan atau waktu tidak valid";
  return;
}

$("nama").value = dataSantri.nama || "‚Äî";
$("kegiatan").textContent = dataSantri.kegiatan || "‚Äî";
$("hari").textContent = dataSantri.hari || "‚Äî";
$("instansi").textContent = dataSantri.instansi || "‚Äî";
$("jabatan").textContent = dataSantri.jabatan || "‚Äî";
$("mulai").textContent = dataSantri.mulai || "‚Äî";
$("selesai").textContent = dataSantri.selesai || "‚Äî";
$("durasi").textContent = dataSantri.durasi || "‚Äî";
$("status").textContent = dataSantri.status || "‚Äî";
$("drs-status").textContent = dataSantri.drsStatus || "‚Äî";

</script>
</body>
</html>









