<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Validasi Jam Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
    }
    .form-box {
      background-color: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 420px;
      margin: 24px auto;
      box-sizing: border-box;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #0077b6;
      background-color: #d0ecff;
      color: #0077b6;
      font-weight: bold;
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .value {
      font-size: 14px;
      font-weight: bold;
      background-color: #eef6fb;
      padding: 6px;
      border-radius: 6px;
      color: #0077b6;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 16px;
      border-radius: 8px;
      border: none;
      background-color: #a8f0c6;
      color: #006644;
      font-weight: bold;
      cursor: pointer;
    }
    #lokasi-status, #debug-info {
      font-weight: bold;
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
      color: #0077b6;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div class="form-box" id="form-box">
  <h2 style="text-align:center; color:#0077b6;">‚úÖ Validasi Jam Kerja</h2>

  <input type="text" id="nama" placeholder="Nama Santri" readonly />
  <input type="text" id="wa" placeholder="Nomor WA" readonly />

  <div class="grid">
    <div><div class="label">Kegiatan</div><div class="value" id="kegiatan">‚Äî</div></div>
    <div><div class="label">Hari</div><div class="value" id="hari">‚Äî</div></div>
    <div><div class="label">Instansi</div><div class="value" id="instansi">‚Äî</div></div>
    <div><div class="label">Jabatan</div><div class="value" id="jabatan">‚Äî</div></div>
    <div><div class="label">Mulai</div><div class="value" id="mulai">‚Äî</div></div>
    <div><div class="label">Selesai</div><div class="value" id="selesai">‚Äî</div></div>
    <div><div class="label">Durasi</div><div class="value" id="durasi">‚Äî</div></div>
    <div><div class="label">Status</div><div class="value" id="status">‚Äî</div></div>
    <div><div class="label">Durasi Status</div><div class="value" id="drs-status">‚Äî</div></div>
    <link rel="icon" href="data:,">
    <pre id="debug-info" style="background:#f0f0f0;padding:1em;border:1px solid #ccc;white-space:pre-wrap;"></pre>
  </div>

  <button id="btn-lokasi">üîê Validasi Lokasi & Absen</button>
  <div id="lokasi-status">‚Äî</div>
  <div id="debug-info">‚Äî</div>
</div>

<script type="module">
  const $ = id => document.getElementById(id);
  const pesantrenLat = -7.036533;
  const pesantrenLng = 112.743574;
  const radiusAman = 500;
  let dataSantri = null;

  function hitungJarak(lat1, lng1, lat2, lng2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  async function ambilDataSantri(wa) {
    const hariMap = { "MINGGU": "AHAD", "JUMAT": "JUM'AT" };
    const hariSekarang = new Intl.DateTimeFormat("id-ID", { weekday: "long" }).format(new Date()).toUpperCase();
    const hariValid = (hariMap[hariSekarang] || hariSekarang).toUpperCase();

    const sekarang = new Date();
    const batasAwal = new Date(sekarang.getTime() - 30 * 60 * 1000);
    const jamAwal = batasAwal.toTimeString().slice(0, 8);
    const jamSekarang = sekarang.toTimeString().slice(0, 8);

    const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_jamker?select=*&wa=ilike.%25${wa}%25&hari=ilike.%25${hariValid}%25&mulai=gte.${jamAwal}&mulai=lte.${jamSekarang}&limit=1`;

    $("debug-info").textContent += `\nüîç Query Jamker:\n${url}`;

    const response = await fetch(url, {
      headers: {
        "apikey": "API_KEY",
        "Authorization": "Bearer API_KEY",
        "Accept": "application/json"
      }
    });

    const result = await response.json();
    $("debug-info").textContent += `\nüì¶ Jamker Response: ${JSON.stringify(result)}`;

    if (!result || result.length === 0) return null;

    const data = result[0];
    return { ...data };
  }

  async function sudahAbsen(wa, kegiatan) {
    const tanggal = new Date().toISOString().slice(0, 10);
    const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_absen?select=id&wa=eq.${wa}&kegiatan=eq.${kegiatan}&tanggal=eq.${tanggal}`;

    $("debug-info").textContent += `\nüîç Query Absen:\n${url}`;

    const response = await fetch(url, {
      headers: {
        "apikey": "API_KEY",
        "Authorization": "Bearer API_KEY",
        "Accept": "application/json"
      }
    });

    const result = await response.json();
    $("debug-info").textContent += `\nüì¶ Absen Response: ${JSON.stringify(result)}`;

    return result.length > 0;
  }

  async function simpanAbsen(data, lat, lng) {
    const payload = {
      wa: data.wa,
      nama: data.nama,
      kegiatan: data.kegiatan,
      hari: data.hari,
      instansi: data.instansi,
      jabatan: data.jabatan,
      mulai: data.mulai,
      selesai: data.selesai,
      durasi: data.durasi,
      status: data.status,
      drs_status: data.drsStatus,
      lat: lat,
      lng: lng,
      tanggal: new Date().toISOString().slice(0, 10),
      jam: new Date().toTimeString().slice(0, 8)
    };

    const response = await fetch("https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_absen", {
      method: "POST",
      headers: {
        "apikey": "API_KEY",
        "Authorization": "Bearer API_KEY",
        "Content-Type": "application/json",
        "Prefer": "return=representation"
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    $("debug-info").textContent += `\nüì• Simpan Absen Response: ${JSON.stringify(result)}`;
  }

  async function prosesAbsen(wa) {
    $("lokasi-status").textContent = "‚è≥ Validasi jam kerja...";
    dataSantri = await ambilDataSantri(wa);
    if (!dataSantri) {
      $("lokasi-status").textContent = "‚ùå Tidak ditemukan di jam kerja aktif";
      return;
    }

    $("lokasi-status").textContent = "‚è≥ Cek apakah sudah absen...";
    if (await sudahAbsen(wa, dataSantri.kegiatan)) {
      $("lokasi-status").textContent = "‚ö†Ô∏è Sudah absen sebelumnya";
      return;
    }

    $("lokasi-status").textContent = "üìç Mengambil lokasi...";
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const jarak = hitungJarak(lat, lng, pesantrenLat, pesantrenLng);

      $("debug-info").textContent += `\nüìç Lokasi: ${lat}, ${lng}\nüìè Jarak ke pesantren: ${Math.round(jarak)} meter`;

      if (jarak > radiusAman) {
        $("lokasi-status").textContent = `üö´ Di luar radius aman (${Math.round(jarak)}m)`;
        return;
      }

      $("lokasi-status").textContent = "‚úÖ Lokasi valid, menyimpan absen...";
      await simpanAbsen(dataSantri, lat, lng);
      $("lokasi-status").textContent = "‚úÖ Absen berhasil disimpan";
    }, err => {
      $("lokasi-status").textContent = `‚ùå Gagal ambil lokasi: ${err.message}`;
    });
  }

  window.addEventListener("DOMContentLoaded", async () => {
    let wa = new URLSearchParams(window.location.search).get("wa") || "";
    wa = wa.replace(/^\+62/, "628").replace(/[^0-9]/g, "");
    $("debug-info").textContent = `‚úÖ WA dimuat: ${wa}`;

    $("btn-lokasi").addEventListener("click", () => prosesAbsen(wa));
  });
</script>

</body>
</html>














