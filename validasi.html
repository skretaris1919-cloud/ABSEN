<!DOCTYPE html> //
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Validasi Jam Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
    }
    .form-box {
      background-color: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 420px;
      margin: 24px auto;
      box-sizing: border-box;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #0077b6;
      background-color: #d0ecff;
      color: #0077b6;
      font-weight: bold;
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .value {
      font-size: 14px;
      font-weight: bold;
      background-color: #eef6fb;
      padding: 6px;
      border-radius: 6px;
      color: #0077b6;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 16px;
      border-radius: 8px;
      border: none;
      background-color: #a8f0c6;
      color: #006644;
      font-weight: bold;
      cursor: pointer;
    }
    #lokasi-status, #debug-info {
      font-weight: bold;
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
      color: #0077b6;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div class="form-box" id="form-box">
  <h2 style="text-align:center; color:#0077b6;">‚úÖ Validasi Jam Kerja</h2>

  <input type="text" id="nama" placeholder="Nama Santri" readonly />
  <input type="text" id="wa" placeholder="Nomor WA" readonly />

  <div class="grid">
    <div><div class="label">Kegiatan</div><div class="value" id="kegiatan">‚Äî</div></div>
    <div><div class="label">Hari</div><div class="value" id="hari">‚Äî</div></div>
    <div><div class="label">Instansi</div><div class="value" id="instansi">‚Äî</div></div>
    <div><div class="label">Jabatan</div><div class="value" id="jabatan">‚Äî</div></div>
    <div><div class="label">Mulai</div><div class="value" id="mulai">‚Äî</div></div>
    <div><div class="label">Selesai</div><div class="value" id="selesai">‚Äî</div></div>
    <div><div class="label">Durasi</div><div class="value" id="durasi">‚Äî</div></div>
    <div><div class="label">Status</div><div class="value" id="status">‚Äî</div></div>
    <div><div class="label">Durasi Status</div><div class="value" id="drs-status">‚Äî</div></div>
  </div>

  <button id="btn-lokasi">üîê Validasi Lokasi & Absen</button>
  <div id="lokasi-status">‚Äî</div>
  <div id="debug-info">‚Äî</div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const supabaseHeaders = {
    apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc",
    Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc",
    "Content-Type": "application/json"
  };

  const wa = new URLSearchParams(window.location.search).get("wa") || "";
  const hariMap = { "MINGGU": "AHAD", "JUMAT": "JUM'AT" };
  const hariSekarang = new Intl.DateTimeFormat("id-ID", { weekday: "long" }).format(new Date()).toUpperCase();
  const hariValid = (hariMap[hariSekarang] || hariSekarang).toUpperCase();
  $("wa").value = wa;

  let dataSantri = null;

  const sekarang = new Date();
  const batas30MenitLalu = new Date(sekarang.getTime() - 30 * 60 * 1000);
  const jamBatas = batas30MenitLalu.toTimeString().slice(0, 8);

  const url = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_jamker?select=*&wa=ilike.${wa}&hari=ilike.${hariValid}&mulai=gte.${jamBatas}&limit=1`;

  $("debug-info").textContent = `‚è≥ Filter waktu aktif: mulai >= ${jamBatas}`;

  fetch(url, {
    method: "GET",
    headers: supabaseHeaders
  })
 .then(data => {
  const sekarang = new Date();
  const batas30MenitLalu = new Date(sekarang.getTime() - 30 * 60 * 1000);

  $("debug-info").textContent = `‚è≥ Filter waktu aktif: mulai >= ${batas30MenitLalu.toTimeString().slice(0, 8)}`;

  const dataValid = data.find(item => {
    const mulaiDate = new Date(`${sekarang.toDateString()} ${item.mulai}`);
    return mulaiDate >= batas30MenitLalu;
  });

  if (!dataValid) {
    $("nama").value = "‚ùå Kegiatan tidak ditemukan";
    $("kegiatan").textContent = "‚Äî";
    $("hari").textContent = hariValid;
    $("instansi").textContent = "‚Äî";
    $("jabatan").textContent = "‚Äî";
    $("mulai").textContent = "‚Äî";
    $("selesai").textContent = "‚Äî";
    $("durasi").textContent = "‚Äî";
    $("status").textContent = "‚ùå Terlampaui";
    $("drs-status").textContent = "Sudah lewat lebih dari 30 menit";
    $("debug-info").textContent += `\n‚ö†Ô∏è Tidak ada kegiatan ditemukan untuk hari ${hariValid} yang masih aktif. Kemungkinan besar jam sudah terlampaui.`;
    return;
  }

  const jamker = dataValid;
  dataSantri = jamker;

  const mulai = new Date(`${sekarang.toDateString()} ${jamker.mulai}`);
  const selisihMs = mulai - sekarang;

  let status = "‚Äî";
  if (Math.abs(selisihMs) <= 5 * 60 * 1000) {
    status = "Pas";
  } else if (selisihMs < 0) {
    status = "Telat";
  } else {
    status = "Maju";
  }

  const formatDurasi = ms => {
    const totalSec = Math.abs(Math.floor(ms / 1000));
    const jam = Math.floor(totalSec / 3600);
    const menit = Math.floor((totalSec % 3600) / 60);
    const detik = totalSec % 60;
    return `${jam.toString().padStart(2,'0')} Jam ${menit.toString().padStart(2,'0')} Menit ${detik.toString().padStart(2,'0')} Detik`;
  };

  const drsStatus = formatDurasi(selisihMs);

  $("nama").value = jamker.nama || "‚Äî";
  $("kegiatan").textContent = jamker.kegiatan || "‚Äî";
  $("hari").textContent = jamker.hari || "‚Äî";
  $("instansi").textContent = jamker.instansi || "‚Äî";
  $("jabatan").textContent = jamker.jabatan || "‚Äî";
  $("mulai").textContent = jamker.mulai || "‚Äî";
  $("selesai").textContent = jamker.selesai || "‚Äî";
  $("durasi").textContent = jamker.durasi || "‚Äî";
  $("status").textContent = status;
  $("drs-status").textContent = drsStatus;
  $("debug-info").textContent += `\n‚úÖ Data berhasil difilter dan dimuat untuk hari ${hariValid}`;
})
  const pesantrenLat = -7.037695;
  const pesantrenLng = 112.747255;
  const radiusAman = 120;

  function hitungJarak(lat1, lng1, lat2, lng2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  $("btn-lokasi").addEventListener("click", async () => {
    if (!navigator.geolocation) {
      $("lokasi-status").textContent = "‚ùå Browser tidak mendukung pelacakan lokasi.";
      return;
    }

    $("lokasi-status").textContent = "‚è≥ Mengambil lokasi...";

    navigator.geolocation.getCurrentPosition(async pos => {
      const userLat = pos.coords.latitude;
      const userLng = pos.coords.longitude;
      const akurasi = pos.coords.accuracy;
      const jarak = hitungJarak(userLat, userLng, pesantrenLat, pesantrenLng);

      $("debug-info").textContent += `\nüìç Lokasi: ${userLat}, ${userLng}\nüìè Jarak: ${jarak.toFixed(2)} m\nüéØ Akurasi: ${akurasi.toFixed(2)} m`;

      if (jarak > radiusAman || akurasi > 1000) {
        $("lokasi-status").textContent = "‚ùå Di luar radius aman Pesantren.";
        return;
      }

      const tanggal = new Date().toISOString().slice(0, 10);
      const jam = new Date().toTimeString().slice(0, 8);

      const cekURL = `https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_absen?select=id&no_id=eq.${dataSantri.no_id}&tanggal=eq.${tanggal}&kegiatan=eq.${dataSantri.kegiatan}&limit=1`;

      const cekRes = await fetch(cekURL, { headers: supabaseHeaders });
      const cekData = await cekRes.json();
      if (cekData.length > 0) {
        $("lokasi-status").textContent = "‚ö†Ô∏è Anda sudah absen hari ini.";
        return;
      }

      const simpanURL = "https://brnqpdvtninzyqqwhmfj.supabase.co/rest/v1/tb_absen";
      const payload = [{
        no_id: dataSantri.no_id,
        nama: dataSantri.nama,
        instansi: dataSantri.instansi,
        jabatan: dataSantri.jabatan,
        kegiatan: dataSantri.kegiatan,
        hari: dataSantri.hari,
        mulai: dataSantri.mulai,
        selesai: dataSantri.selesai,
        drs_kegiatan: $("durasi").textContent,
        status: $("status").textContent,
        drs_status: $("drs-status").textContent,
        tanggal: tanggal,
        jam_absen: jam
      }];

      const simpanRes = await fetch(simpanURL, {
        method: "POST",
        headers: supabaseHeaders,
        body: JSON.stringify(payload)
      });

      if (simpanRes.ok) {
        $("lokasi-status").textContent = "‚úÖ Absen berhasil disimpan.";
      } else {
        const err = await simpanRes.json();
        $("lokasi-status").textContent = "‚ùå Gagal simpan absen.";
        $("debug-info").textContent += `\nüõ†Ô∏è Error simpan: ${err.message}`;
      }

    }, err => {
      $("lokasi-status").textContent = "‚ùå Gagal ambil lokasi: " + err.message;
      $("debug-info").textContent += `\nüõ†Ô∏è Geolocation error: ${err.message}`;
    });
  });
</script>
</body>
</html>










